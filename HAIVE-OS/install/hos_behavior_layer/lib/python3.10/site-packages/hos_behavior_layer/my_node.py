import rclpy
from rclpy.node import Node
from std_msgs.msg import Int8

from hos_device_layer.topics import DEVICE_API_CALL_RESULT_TOPIC
from hos_interfaces.msg import DeviceAPICallResult
import hos_device_layer.gen.hos_device_api as DeviceAPI


node_name = 'my_node'

class MyNode(Node):
  def __init__(self):
    super().__init__(node_name)

    self._api_call_infos = []

    self.create_subscription(Int8, 'haive_os/my_node/move_container', lambda msg: self.move_container(msg.data), 10)
    self.create_subscription(DeviceAPICallResult, DEVICE_API_CALL_RESULT_TOPIC, self._on_device_api_call_result, 10)

  def move_container(self, distance: int):
    api_call_info = DeviceAPI.container_move(self, 'C4005', distance, 75)
    self._api_call_infos.append(api_call_info)

  def _on_device_api_call_result(self, msg: DeviceAPICallResult):
    self.get_logger().info(f"_on_device_api_call_result: task_id={msg.task_id} | success={msg.success} | error={msg.error} | result_jsons={msg.result_jsons} | request_time_s={msg.request_time_s} | response_time_s={msg.response_time_s}")

  def spin(self):
    while rclpy.ok():
      rclpy.spin_once(self)

      api_call_infos = []

      for api_call_info in self._api_call_infos:
        future = api_call_info.future

        if future.done():
          res = future.result()

          if res.is_valid:
            self.get_logger().info(f"DeviceAPICall sucess: task_id={res.task_id}")
          else:
            self.get_logger().error(f"DeviceAPICall failed: {res.error}")

        else:
          api_call_infos.append(api_call_info)

      self._api_call_infos = api_call_infos


def main(args=None):
  rclpy.init(args=args)

  node = MyNode()

  node.get_logger().info(f"Running {node_name}")
  node.spin()

  node.destroy_node()
  rclpy.shutdown()

if __name__ == '__main__':
  main()
